# SWM (Shared Working Memory) Service - (dcs_memory/services/swm)

Это gRPC сервис для Общей Рабочей Памяти (SWM) в рамках проекта Динамической Контекстуализированной Общей Памяти (ДКОП).
SWM выступает как активный кэширующий слой для Контекстуализированных Единиц Памяти (КЕП), с которым взаимодействуют агенты. SWM может загружать КЕПы из GLM (Global Long-Term Memory), хранить их в своем кэше и предоставлять агентам через запросы и подписки.

Сервис использует централизованные определения `.proto` файлов (`kem.proto`, `glm_service.proto`, `swm_service.proto`), расположенные в `dcs_memory/common/grpc_protos/`.

## Основные Функции

*   **Кэширование КЕП:** Хранит активные КЕП в LRU-кэше для быстрого доступа.
*   **Взаимодействие с GLM:** Может загружать КЕП из GLM по запросу и опционально сохранять/обновлять КЕП в GLM.
*   **Публикация КЕП:** Агенты могут публиковать КЕП в SWM.
*   **Запрос КЕП:** Агенты могут запрашивать КЕП из кэша SWM с поддержкой фильтрации.
*   **Подписка на события (базовая/заглушка):** Предоставляет стрим событий SWM.

## Зависимости

*   Python 3.8+
*   Pip
*   **GLM Service**: Должен быть запущен и доступен для SWM.

## Настройка и Запуск

1.  **Клонируйте репозиторий** (если вы еще этого не сделали).

2.  **Убедитесь, что GLM сервис запущен** и доступен по адресу, указанному в конфигурации SWM (см. Переменные окружения). GLM, в свою очередь, требует доступный Qdrant и SQLite.

3.  **Перейдите в директорию SWM сервиса:**
    ```bash
    cd dcs_memory/services/swm
    ```

4.  **Создайте и активируйте виртуальное окружение (рекомендуется):**
    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

5.  **Установите зависимости Python:**
    ```bash
    pip install -r requirements.txt
    ```
    (Включает `grpcio`, `cachetools` и т.д.)

6.  **Сгенерируйте gRPC код (если вы изменяли `.proto` файлы):**
    Скрипт `generate_grpc_code.sh` в текущей директории (`dcs_memory/services/swm/`) отвечает за генерацию Python кода в локальную директорию `generated_grpc/`.
    ```bash
    ./generate_grpc_code.sh
    ```
    *Убедитесь, что скрипт имеет права на выполнение (`chmod +x generate_grpc_code.sh`).*

7.  **Настройте переменные окружения (обязательно для GLM_SERVICE_ADDRESS, опционально для остального):**
    *   `GLM_SERVICE_ADDRESS`: Адрес запущенного GLM сервиса (например, `localhost:50051`). **Обязательно.**
    *   `SWM_GRPC_LISTEN_ADDRESS`: Адрес, на котором SWM будет слушать (по умолчанию: `[::]:50053`).
    *   `SWM_CACHE_MAX_SIZE`: Максимальное количество КЕП в LRU-кэше SWM (по умолчанию: `200`).
    *   `DEFAULT_SWM_PAGE_SIZE`: Размер страницы по умолчанию для `QuerySWM` (по умолчанию: `20`).


8.  **Запустите gRPC сервер SWM:**
    Из директории `dcs_memory/services/swm/`:
    ```bash
    python -m app.main
    ```
    Сервер попытается подключиться к GLM. Логи будут выводиться в консоль.

## API (gRPC)

Сервис реализует gRPC интерфейс, определенный в `swm_service.proto` (находится в `dcs_memory/common/grpc_protos/`).

Основные методы:
*   **`PublishKEMToSWM(PublishKEMToSWMRequest) returns (PublishKEMToSWMResponse)`**:
    *   Публикует КЕП в кэш SWM.
    *   Если `persist_to_glm_if_new_or_updated` = true, SWM попытается сохранить/обновить КЕП в GLM.
    *   Возвращает ID КЕП, статус публикации в SWM и статус попытки сохранения в GLM.
*   **`SubscribeToSWMEvents(SubscribeToSWMEventsRequest) returns (stream SWMMemoryEvent)`**:
    *   Позволяет агенту подписаться на события в SWM (например, `KEM_PUBLISHED`, `KEM_UPDATED`, `KEM_EVICTED`).
    *   Запрос содержит ID агента и список тем/фильтров.
    *   Возвращает поток `SWMMemoryEvent`.
    *   **Примечание:** Текущая реализация этого метода является базовой заглушкой и возвращает только несколько тестовых событий. Полноценная система Pub/Sub требует доработки.
*   **`QuerySWM(QuerySWMRequest) returns (QuerySWMResponse)`**:
    *   Запрашивает КЕП из внутреннего кэша SWM, используя `KEMQuery` (из `glm_service.proto`) и пагинацию.
    *   **Поддерживаемые фильтры в `KEMQuery` для SWM кэша:**
        *   `ids`: Извлечение по списку ID КЕП.
        *   `metadata_filters`: Точное совпадение по ключам и значениям в метаданных КЕП.
        *   Фильтры по датам (`created_at_start/end`, `updated_at_start/end`).
    *   **Неподдерживаемые фильтры в `KEMQuery` для SWM кэша:**
        *   `embedding_query` и `text_query`: Векторный и текстовый поиск напрямую в SWM не производятся. SWM не является векторной базой данных и не выполняет преобразование текста в эмбеддинги. Для таких операций используйте GLM (для векторного поиска) или KPS (для генерации эмбеддингов). При указании этих полей в запросе к `QuerySWM` метод вернет ошибку.
    *   Поддерживает пагинацию через `page_size` и `page_token`.
*   **`LoadKEMsFromGLM(LoadKEMsFromGLMRequest) returns (LoadKEMsFromGLMResponse)`**:
    *   Запрашивает у SWM загрузку КЕП из GLM в свой кэш на основе `KEMQuery`.
    *   Возвращает количество загруженных КЕП и их ID.

Обратитесь к файлам `kem.proto`, `glm_service.proto` и `swm_service.proto` для детального описания всех сообщений и полей.

## Тестирование

Директория `tests/` предназначена для модульных и интеграционных тестов (пока не реализованы).
Для ручного тестирования:
1.  Убедитесь, что GLM сервис запущен.
2.  Запустите SWM сервис.
3.  Используйте gRPC-клиент для вызова методов SWM.
