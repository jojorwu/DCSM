# KPS (Knowledge Processor Service) - (dcs_memory/services/kps)

Это gRPC сервис для Обработки Знаний (KPS) в рамках проекта Динамической Контекстуализированной Общей Памяти (ДКОП).
Основная задача сервиса - принимать сырые данные, обрабатывать их (включая генерацию эмбеддингов для текстового контента) для формирования Контекстуализированных Единиц Памяти (КЕП) и инициировать их сохранение в Сервисе Глобальной/Долгосрочной Памяти (GLM).

Сервис использует централизованные определения `.proto` файлов (`kem.proto`, `glm_service.proto`, `kps_service.proto`), расположенные в `dcs_memory/common/grpc_protos/`.

## Зависимости

*   Python 3.8+
*   Pip
*   **GLM Service**: Должен быть запущен и доступен для KPS.
*   **Sentence Transformer Model**: Модель для генерации эмбеддингов загружается при старте (по умолчанию `all-MiniLM-L6-v2`). Для этого может потребоваться доступ в интернет при первом запуске для скачивания модели.

## Настройка и Запуск

1.  **Клонируйте репозиторий** (если вы еще этого не сделали).

2.  **Убедитесь, что GLM сервис запущен** и доступен по адресу, указанному в конфигурации KPS (см. Переменные окружения). GLM, в свою очередь, требует доступный Qdrant.

3.  **Перейдите в директорию KPS сервиса:**
    ```bash
    cd dcs_memory/services/kps
    ```

4.  **Создайте и активируйте виртуальное окружение (рекомендуется):**
    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

5.  **Установите зависимости Python:**
    ```bash
    pip install -r requirements.txt
    ```
    (Включает `grpcio`, `sentence-transformers` и т.д.)
    *Примечание: установка `sentence-transformers` и его зависимостей (например, PyTorch) может занять некоторое время и потребовать значительного дискового пространства.*

6.  **Сгенерируйте gRPC код (если вы изменяли `.proto` файлы):**
    Скрипт `generate_grpc_code.sh` в текущей директории (`dcs_memory/services/kps/`) отвечает за генерацию Python кода в локальную директорию `generated_grpc/`. Он генерирует:
    *   Серверный код для KPS (из `kps_service.proto`).
    *   Клиентский код для GLM (из `glm_service.proto`).
    *   Код для общих сообщений (из `kem.proto`).
    ```bash
    ./generate_grpc_code.sh
    ```
    *Убедитесь, что скрипт имеет права на выполнение (`chmod +x generate_grpc_code.sh`).*

7.  **Настройте переменные окружения (обязательно для GLM_SERVICE_ADDRESS, опционально для остального):**
    *   `GLM_SERVICE_ADDRESS`: Адрес запущенного GLM сервиса (например, `localhost:50051`). **Обязательно.**
    *   `KPS_GRPC_LISTEN_ADDRESS`: Адрес, на котором KPS будет слушать (по умолчанию: `[::]:50052`).
    *   `SENTENCE_TRANSFORMER_MODEL`: Имя или путь к модели sentence-transformer (по умолчанию: `all-MiniLM-L6-v2`).
    *   `DEFAULT_VECTOR_SIZE`: Ожидаемая/генерируемая размерность эмбеддингов (по умолчанию: `384` для `all-MiniLM-L6-v2`). **Это значение должно строго соответствовать конфигурации векторной БД в GLM сервисе (Qdrant).**

8.  **Запустите gRPC сервер KPS:**
    Из директории `dcs_memory/services/kps/`:
    ```bash
    python -m app.main
    ```
    Сервер попытается загрузить модель эмбеддингов и подключиться к GLM. Логи будут выводиться в консоль.

## API (gRPC)

Сервис реализует gRPC интерфейс, определенный в `kps_service.proto` (находится в `dcs_memory/common/grpc_protos/`).

Основной метод:
*   **`ProcessRawData(ProcessRawDataRequest) returns (ProcessRawDataResponse)`**:
    *   Принимает `ProcessRawDataRequest`, содержащий:
        *   `data_id` (string, опционально): ID для отслеживания исходных данных.
        *   `content_type` (string): MIME-тип контента (например, "text/plain").
        *   `raw_content` (bytes): Сырое содержимое данных.
        *   `initial_metadata` (map<string, string>): Начальные метаданные для КЕП.
    *   Обрабатывает данные: для текстового контента генерирует эмбеддинги с помощью `sentence-transformers`.
    *   Формирует объект `KEM`.
    *   Вызывает `StoreKEM` GLM-сервиса для сохранения КЕП.
    *   Возвращает `ProcessRawDataResponse`, содержащий:
        *   `kem_id` (string): ID сохраненной КЕП в GLM.
        *   `success` (bool): Статус операции.
        *   `status_message` (string): Сообщение о результате.

## Тестирование

Директория `tests/` предназначена для модульных и интеграционных тестов (пока не реализованы).
Для ручного тестирования можно использовать gRPC-клиент (например, `grpcurl` или Python-клиент), отправляя запросы `ProcessRawDataRequest` и проверяя, что КЕПы корректно создаются и сохраняются в GLM (через API GLM или напрямую проверяя базы данных GLM).
