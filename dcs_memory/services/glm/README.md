# GLM (Global Long-Term Memory) Service - (dcs_memory/services/glm)

Это реализация gRPC сервиса для Глобальной Долгосрочной Памяти (GLM) в рамках проекта Динамической Контекстуализированной Общей Памяти (ДКОП).
Сервис предоставляет API для сохранения, извлечения, обновления и удаления Контекстуализированных Единиц Памяти (КЕП).

Данный сервис использует централизованные определения `.proto` файлов, расположенные в `dcs_memory/common/grpc_protos/`.

## Архитектура Хранения

*   **Векторная база данных:** Qdrant (используется для хранения эмбеддингов КЕП и выполнения поиска по сходству).
*   **База данных метаданных:** SQLite (используется для хранения самих КЕП: ID, тип контента, контент, метаданные в формате JSON, временные метки). Файл базы данных по умолчанию создается как `app/glm_metadata.sqlite3` внутри директории сервиса.

## Предварительные требования

*   Python 3.8+
*   Pip
*   Docker (для локального запуска Qdrant, если не используется облачная версия)

## Настройка и Запуск

1.  **Клонируйте репозиторий** (если вы еще этого не сделали).

2.  **Настройте Qdrant:**
    Для локальной разработки рекомендуется запустить Qdrant с помощью Docker:
    ```bash
    docker pull qdrant/qdrant
    docker run -p 6333:6333 -p 6334:6334 \
        -v $(pwd)/qdrant_storage:/qdrant/storage:z \
        qdrant/qdrant
    ```
    Это запустит Qdrant и будет хранить его данные в директории `qdrant_storage` в вашем текущем каталоге.
    Сервис GLM попытается подключиться к Qdrant по адресу, указанному в переменных окружения (см. ниже).

3.  **Перейдите в директорию сервиса:**
    ```bash
    cd dcs_memory/services/glm
    ```

4.  **Создайте и активируйте виртуальное окружение (рекомендуется):**
    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

5.  **Установите зависимости Python:**
    ```bash
    pip install -r requirements.txt
    ```
    (Включает `qdrant-client`, `grpcio`, и т.д.)

6.  **Сгенерируйте gRPC код (если вы изменяли `.proto` файлы):**
    Этот сервис использует `.proto` файлы из центральной директории (`../../common/grpc_protos/`). Скрипт `generate_grpc_code.sh` в текущей директории (`dcs_memory/services/glm/`) отвечает за генерацию Python кода в локальную директорию `generated_grpc/`.
    ```bash
    ./generate_grpc_code.sh
    ```
    *Убедитесь, что скрипт имеет права на выполнение (`chmod +x generate_grpc_code.sh`).*

7.  **Настройте переменные окружения (опционально):**
    Сервис можно сконфигурировать с помощью следующих переменных окружения:
    *   `SQLITE_DB_FILENAME`: Имя файла SQLite базы данных (по умолчанию: `glm_metadata.sqlite3` внутри директории `app/`).
    *   `QDRANT_HOST`: Хост Qdrant (по умолчанию: `localhost`).
    *   `QDRANT_PORT`: Порт Qdrant (по умолчанию: `6333`).
    *   `QDRANT_COLLECTION`: Имя коллекции в Qdrant (по умолчанию: `glm_kems_demo_collection`).
    *   `DEFAULT_VECTOR_SIZE`: Размерность векторов для Qdrant (по умолчанию: `25`). **Важно:** это значение должно соответствовать размерности эмбеддингов, которые вы будете сохранять.
    *   `DEFAULT_PAGE_SIZE`: Размер страницы по умолчанию для `RetrieveKEMs` (по умолчанию: `10`).
    *   `GRPC_LISTEN_ADDRESS`: Адрес, на котором gRPC сервер будет слушать (по умолчанию: `[::]:50051`).

8.  **Запустите gRPC сервер:**
    Из директории `dcs_memory/services/glm/`:
    ```bash
    python -m app.main
    ```
    Сервер попытается подключиться к Qdrant и инициализировать SQLite. Логи будут выводиться в консоль.

## API (gRPC)

Сервис реализует gRPC интерфейс, определенный в `glm_service.proto` (находится в `dcs_memory/common/grpc_protos/`).

Основные методы:
*   **`StoreKEM(StoreKEMRequest) returns (StoreKEMResponse)`**:
    *   Сохраняет одну КЕП. Если `id` в `KEM` не указан, сервер его генерирует.
    *   Возвращает полный сохраненный объект `KEM`, включая серверный `id` и временные метки `created_at`, `updated_at`.
*   **`RetrieveKEMs(RetrieveKEMsRequest) returns (RetrieveKEMsResponse)`**:
    *   Извлекает КЕП по различным критериям, указанным в `KEMQuery` (часть запроса).
    *   Поддерживает фильтрацию по списку ID, векторный поиск (по `embedding_query`), фильтры по метаданным и диапазонам дат (`created_at`, `updated_at`).
    *   Поддерживает пагинацию через `page_size` и `page_token`.
    *   Возвращает список КЕП и `next_page_token` для следующей страницы.
*   **`UpdateKEM(UpdateKEMRequest) returns (KEM)`**:
    *   Обновляет существующую КЕП по `kem_id`. Поля для обновления передаются в `kem_data_update`.
    *   Обновляет `updated_at`. `created_at` не меняется.
    *   Возвращает полный обновленный объект `KEM`.
*   **`DeleteKEM(DeleteKEMRequest) returns (google.protobuf.Empty)`**:
    *   Удаляет КЕП по `kem_id` из всех хранилищ (SQLite и Qdrant).

Обратитесь к файлам `kem.proto` и `glm_service.proto` для детального описания всех сообщений и полей.

## Тестирование

Директория `tests/` предназначена для модульных и интеграционных тестов (пока не реализованы).
Для ручного тестирования можно использовать gRPC-клиент, такой как `grpcurl` или Python-клиент (например, из `dcsm_agent_sdk_python`).
